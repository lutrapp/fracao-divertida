<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mestre das Fra√ß√µes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #FFF8E1; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            color: #5D4037; 
            overflow-x: hidden;
        }
        
        .main-card { 
            background: white; 
            border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border-bottom: 6px solid #FFECB3;
            margin-top: 10px;
            padding-bottom: 10px;
        }

        .header { 
            background: linear-gradient(135deg, #FF9800, #F57C00); 
            color: white; 
            border-radius: 20px 20px 5px 5px; 
            padding: 15px; 
            margin-bottom: 15px;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            background: #fff3e0;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 15px;
            position: relative;
            min-height: 100px;
        }

        .fraction-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 5px 10px;
            border-radius: 10px;
            border: 2px solid #FFB74D;
            transition: all 0.3s;
        }

        .fraction-part { 
            width: 60px !important; 
            font-size: 1.2rem; 
            text-align: center; 
            border: none;
            background: transparent;
            color: #E65100; 
            font-weight: bold;
            padding: 2px;
            outline: none;
        }
        
        .fraction-line {
            width: 100%;
            height: 2px;
            background-color: #E65100;
            margin: 2px 0;
        }
        
        /* Anima√ß√£o de erro (tremida) */
        .input-error {
            border-color: #d32f2f !important;
            background-color: #ffebee !important;
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .op-sign { font-size: 1.5rem; font-weight: bold; color: #F57C00; }

        .btn-cook { 
            background: linear-gradient(to bottom, #4CAF50, #388E3C);
            color: white; 
            font-weight: bold;
            border-radius: 50px;
            border: none;
            box-shadow: 0 4px 0 #2E7D32;
            width: 100%;
            padding: 10px;
            transition: transform 0.1s;
        }
        .btn-cook:active { transform: translateY(4px); box-shadow: none; }

        .btn-explain {
            background: #FFF3E0;
            color: #E65100;
            font-weight: bold;
            border-radius: 50px;
            border: 2px solid #FFB74D;
            padding: 5px 15px;
            font-size: 0.9rem;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-explain:hover { background: #FFE0B2; }

        .visual-stage {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 5px;
            min-height: 150px;
        }

        .fraction-box {
            position: relative;
            text-align: center;
            transition: all 0.3s;
        }

        canvas { 
            width: 42vw; 
            height: 42vw;
            max-width: 180px;
            max-height: 180px;
            min-width: 140px;
            min-height: 140px;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.1));
        }

        .math-symbol {
            font-size: 1.5rem;
            color: #8D6E63;
            font-weight: bold;
            margin: 0 2px;
        }

        .label-equiv {
            font-size: 0.75rem;
            color: #2E7D32;
            background: #E8F5E9;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* Alerta Personalizado */
        #errorMsg {
            display: none;
            background-color: #FFEBEE;
            color: #C62828;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            border: 1px solid #FFCDD2;
            font-weight: bold;
        }

        footer { font-size: 0.8rem; color: #a1887f; margin-top: 15px; }

        @media (min-width: 500px) {
            canvas { width: 180px; height: 180px; max-width: none; max-height: none; }
            .fraction-input { width: 90px !important; }
        }
    </style>
</head>
<body>

<div class="container p-2">
    <div class="main-card mx-auto" style="max-width: 600px;">
        <div class="header text-center">
            <h1 class="h5 mb-0 fw-bold">üçï Cantina das Fra√ß√µes üç´</h1>
        </div>

        <div class="px-3">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <select id="mode" class="form-select form-select-sm shadow-none border-warning text-secondary fw-bold" onchange="updateUI()">
                        <option value="view">üëÄ S√≥ Ver</option>
                        <option value="add">‚ûï Somar</option>
                        <option value="sub">‚ûñ Subtrair</option>
                    </select>
                </div>
                <div class="col-6">
                    <select id="food" class="form-select form-select-sm shadow-none border-warning text-secondary fw-bold" onchange="run()">
                        <option value="pizza">üçï Pizza</option>
                        <option value="choco">üç´ Choco</option>
                    </select>
                </div>
            </div>

            <div id="errorMsg" class="text-center"></div>

            <div class="controls-row">
                <div id="fg1" class="fraction-group">
                    <input type="number" id="n1" class="fraction-part" value="1" inputmode="numeric" max="100">
                    <div class="fraction-line"></div>
                    <input type="number" id="d1" class="fraction-part" value="2" inputmode="numeric" min="0" max="100">
                </div>
                
                <span id="uiSign" class="op-sign d-none">+</span>
                
                <div id="fg2" class="fraction-group d-none">
                    <input type="number" id="n2" class="fraction-part" value="1" inputmode="numeric" max="100">
                    <div class="fraction-line"></div>
                    <input type="number" id="d2" class="fraction-part" value="3" inputmode="numeric" min="0" max="100">
                </div>
            </div>

            <button class="btn btn-cook mb-4" onclick="run()">PREPARAR PEDIDO!</button>
            
            <div class="text-center mb-3">
                <button id="btnExplain" class="btn-explain d-none" onclick="explain()">ü§î Me explique</button>
            </div>

            <div class="visual-stage" id="stage">
                <div class="fraction-box">
                    <div id="lbl1" class="label-equiv"></div>
                    <canvas id="c1" width="300" height="300"></canvas>
                </div>

                <div id="sym1" class="math-symbol d-none">+</div>

                <div id="box2" class="fraction-box d-none">
                    <div id="lbl2" class="label-equiv"></div>
                    <canvas id="c2" width="300" height="300"></canvas>
                </div>

                <div id="sym2" class="math-symbol d-none">=</div>

                <div id="box3" class="fraction-box d-none">
                    <div id="lbl3" class="label-equiv" style="background:#FFEBEE; color:#C62828">Resultado</div>
                    <canvas id="c3" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center">
        Criado por <strong>Lu Trapp + ia</strong>
    </footer>
</div>

<!-- Modal de Explica√ß√£o -->
<div class="modal fade" id="explainModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 20px; border: 4px solid #FFB74D;">
      <div class="modal-header" style="background-color: #FFF8E1; border-bottom: 2px solid #FFE0B2; border-radius: 16px 16px 0 0;">
        <h5 class="modal-title fw-bold" style="color: #E65100;">üí° Como a gente resolveu?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="font-size: 1.1rem; color: #5D4037; line-height: 1.6;">
        <div id="explainContent"></div>
      </div>
      <div class="modal-footer" style="border-top: none;">
        <button type="button" class="btn btn-warning fw-bold text-white" data-bs-dismiss="modal" style="border-radius: 20px;">Entendi! üëç</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Divis√£o por Zero -->
<div class="modal fade" id="zeroModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 20px; border: 4px solid #F44336;">
      <div class="modal-header" style="background-color: #FFEBEE; border-bottom: 2px solid #FFCDD2; border-radius: 16px 16px 0 0;">
        <h5 class="modal-title fw-bold" style="color: #C62828;">‚õî Opa! Algo deu errado...</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" style="font-size: 1.1rem; color: #5D4037; line-height: 1.6;">
        <p class="fw-bold" style="font-size: 3rem;">üö´</p>
        <p>N√£o d√° para dividir nada por <strong>ZERO</strong>!</p>
        <p>Imagine que voc√™ tem uma pizza inteira e quer dividir para <strong>0 pessoas</strong>. N√£o faz sentido, n√©? A pizza n√£o pode desaparecer!</p>
        <p class="text-muted small">Matematicamente, dividir por zero √© imposs√≠vel.</p>
      </div>
      <div class="modal-footer" style="border-top: none; justify-content: center;">
        <button type="button" class="btn btn-danger fw-bold text-white" data-bs-dismiss="modal" style="border-radius: 20px;">Entendi, vou corrigir!</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let animId = null;
    let lastResult = null; // Para guardar o contexto da explica√ß√£o

    function updateUI() {
        const m = document.getElementById('mode').value;
        const isView = m === 'view';
        
        document.getElementById('fg2').classList.toggle('d-none', isView);
        document.getElementById('uiSign').classList.toggle('d-none', isView);
        document.getElementById('uiSign').innerText = m === 'add' ? '+' : '-';

        document.getElementById('box2').classList.toggle('d-none', isView);
        document.getElementById('box3').classList.toggle('d-none', isView);
        document.getElementById('sym1').classList.toggle('d-none', isView);
        document.getElementById('sym1').innerText = m === 'add' ? '+' : '-';
        document.getElementById('sym2').classList.toggle('d-none', isView);
        
        // Esconde bot√£o de explica√ß√£o ao mudar modo, reaparece ap√≥s 'run'
        document.getElementById('btnExplain').classList.add('d-none');
        
        hideError(); // Limpa erros ao mudar o modo
        run(); // Recalcula para atualizar a visualiza√ß√£o
    }

    function parse(suffix) {
        const groupEl = document.getElementById('fg' + suffix);
        const nEl = document.getElementById('n' + suffix);
        const dEl = document.getElementById('d' + suffix);
        
        // Remove estado de erro anterior
        groupEl.classList.remove('input-error');

        let n = parseInt(nEl.value);
        let d = parseInt(dEl.value);

        // Tratamento de NaN
        if(isNaN(n)) n = 0;
        if(isNaN(d)) d = 1;

        return { n: n, d: d, el: groupEl };
    }

    function showError(msg, element) {
        const errBox = document.getElementById('errorMsg');
        errBox.innerText = "‚ö†Ô∏è " + msg;
        errBox.style.display = 'block';
        if(element) element.classList.add('input-error');
    }

    function hideError() {
        document.getElementById('errorMsg').style.display = 'none';
        document.querySelectorAll('.fraction-group').forEach(e => e.classList.remove('input-error'));
    }

    function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
    function lcm(a, b) { return (a * b) / gcd(a, b); }

    function run() {
        if (animId) cancelAnimationFrame(animId);
        hideError();
        
        const f1 = parse(1);
        const f2 = parse(2);
        const mode = document.getElementById('mode').value;
        const food = document.getElementById('food').value;

        // --- REGRA MATEM√ÅTICA: DIVIS√ÉO POR ZERO ---
        // Se denominador for zero, mostra modal e limpa tudo
        if (f1.d === 0 || (mode !== 'view' && f2.d === 0)) {
            // Limpa visualiza√ß√£o
            document.getElementById('c1').getContext('2d').clearRect(0,0,300,300);
            document.getElementById('c2').getContext('2d').clearRect(0,0,300,300);
            document.getElementById('c3').getContext('2d').clearRect(0,0,300,300);
            document.getElementById('lbl1').innerText = "";
            document.getElementById('lbl2').innerText = "";
            document.getElementById('lbl3').innerText = "";
            
            // Abre modal explicativo
            new bootstrap.Modal(document.getElementById('zeroModal')).show();
            return; 
        }

        // --- REGRA MATEM√ÅTICA: DENOMINADOR NEGATIVO ---
        if (f1.d < 0) {
            showError("O n√∫mero de baixo n√£o pode ser negativo! Use apenas n√∫meros positivos.", f1.el);
            return;
        }
        if (mode !== 'view' && f2.d < 0) {
            showError("O n√∫mero de baixo n√£o pode ser negativo! Use apenas n√∫meros positivos.", f2.el);
            return;
        }

        // --- REGRA DE LIMITES (M√ÅXIMO 100) ---
        if (Math.abs(f1.n) > 100 || Math.abs(f1.d) > 100) {
            showError("Vamos com calma! Use n√∫meros at√© 100 para n√£o travar a cozinha.", f1.el);
            return;
        }
        if (mode !== 'view' && (Math.abs(f2.n) > 100 || Math.abs(f2.d) > 100)) {
            showError("Vamos com calma! Use n√∫meros at√© 100 para n√£o travar a cozinha.", f2.el);
            return;
        }

        // --- REGRA MATEM√ÅTICA: ZERO NO NUMERADOR ---
        // Se f1.n for 0, o desenho ser√° vazio (correto visualmente).
        // Nenhuma a√ß√£o extra necess√°ria, a matem√°tica funciona (0/5 = 0).

        const den = mode === 'view' ? f1.d : lcm(f1.d, f2.d);
        const n1A = f1.n * (den / f1.d);
        const n2A = f2.n * (den / f2.d);

        // Labels
        document.getElementById('lbl1').innerText = f1.d !== den ? `${f1.n}/${f1.d} = ${n1A}/${den}` : `${f1.n}/${f1.d}`;
        
        // Salva contexto para explica√ß√£o
        lastResult = {
            f1: f1,
            f2: f2,
            n1A: n1A,
            n2A: n2A,
            commonDen: den,
            mode: mode
        };
        
        // Mostra bot√£o de explica√ß√£o
        document.getElementById('btnExplain').classList.remove('d-none');

        if (mode !== 'view') {
            document.getElementById('lbl2').innerText = f2.d !== den ? `${f2.n}/${f2.d} = ${n2A}/${den}` : `${f2.n}/${f2.d}`;
            const finalN = mode === 'add' ? n1A + n2A : n1A - n2A;
            document.getElementById('lbl3').innerText = `${finalN}/${den}`;
            animate(n1A, n2A, den, mode, food);
        } else {
            animate(n1A, 0, den, mode, food);
        }
    }

    function explain() {
        if (!lastResult) return;
        const ctx = lastResult;
        let html = "";

        if (ctx.mode === 'view') {
            const whole = ctx.f1.n / ctx.f1.d;
            
            html += `<p>Olha s√≥! A fra√ß√£o <strong>${ctx.f1.n}/${ctx.f1.d}</strong> significa que a gente dividiu algo em <strong>${ctx.f1.d}</strong> peda√ßos iguais e pegou <strong>${ctx.f1.n}</strong> deles.</p>`;
            
            if (Number.isInteger(whole)) {
                html += `<div class="alert alert-success border-success" role="alert">`;
                html += `<h5 class="alert-heading fw-bold">üçï Uau! Deu exato! üéâ</h5>`;
                html += `<p class="mb-0">Se a gente juntar todos esses peda√ßos, formamos exatamente <strong>${whole}</strong> coisas inteiras! Nem sobra farelo!</p>`;
                html += `<hr><p class="mb-0 small">Isso acontece quando o n√∫mero de cima d√° para dividir certinho pelo de baixo.</p>`;
                html += `</div>`;
            } else if (ctx.f1.n > ctx.f1.d) {
                const wholes = Math.floor(whole);
                const remainder = ctx.f1.n % ctx.f1.d;
                html += `<div class="alert alert-warning border-warning" role="alert">`;
                html += `<h6 class="fw-bold">üò≤ √â muita comida!</h6>`;
                html += `<p>Como pegamos mais peda√ßos do que uma coisa inteira tem, precisamos de mais de uma!</p>`;
                html += `<p class="mb-0">Isso d√° <strong>${wholes}</strong> inteiras e ainda sobra <strong>${remainder}/${ctx.f1.d}</strong>.</p>`;
                html += `</div>`;
            }
        } else {
            // Explica√ß√£o de Soma/Subtra√ß√£o
            html += `<p>Para fazer a conta, precisamos que os peda√ßos tenham o <strong>mesmo tamanho</strong>.</p>`;
            
            if (ctx.f1.d !== ctx.commonDen || ctx.f2.d !== ctx.commonDen) {
                html += `<p>Por isso, transformamos tudo para dividir em <strong>${ctx.commonDen}</strong> peda√ßos:</p>`;
                html += `<ul>`;
                html += `<li>A primeira virou <strong>${ctx.n1A}/${ctx.commonDen}</strong></li>`;
                html += `<li>A segunda virou <strong>${ctx.n2A}/${ctx.commonDen}</strong></li>`;
                html += `</ul>`;
            } else {
                html += `<p>Como os dois j√° est√£o divididos em <strong>${ctx.commonDen}</strong>, √© s√≥ fazer a conta direto!</p>`;
            }

            if (ctx.mode === 'add') {
                const total = ctx.n1A + ctx.n2A;
                const wholeTotal = total / ctx.commonDen;
                
                html += `<p>Agora somamos os peda√ßos: <strong>${ctx.n1A} + ${ctx.n2A} = ${total}</strong>.</p>`;
                
                if (Number.isInteger(wholeTotal)) {
                     html += `<div class="alert alert-success border-success" role="alert">`;
                     html += `<h5 class="alert-heading fw-bold">üéâ Resultado Inteiro!</h5>`;
                     html += `<p class="mb-0">A soma deu <strong>${total}/${ctx.commonDen}</strong>, que √© igual a <strong>${wholeTotal}</strong> inteiros!</p>`;
                     html += `</div>`;
                } else {
                    html += `<p class="fw-bold text-success">Resultado final: ${total}/${ctx.commonDen}</p>`;
                }
            } else {
                const total = ctx.n1A - ctx.n2A;
                html += `<p>Agora subtra√≠mos os peda√ßos: <strong>${ctx.n1A} - ${ctx.n2A} = ${total}</strong>.</p>`;
                
                if (total < 0) {
                    html += `<div class="alert alert-danger border-danger" role="alert">`;
                    html += `<p><strong>Ops!</strong> Tiramos mais peda√ßos do que t√≠nhamos (<strong>${ctx.n1A}</strong> menos <strong>${ctx.n2A}</strong>).</p>`;
                    html += `<p class="mb-0">O resultado √© negativo, por isso virou uma <strong>d√≠vida</strong> de <strong>${Math.abs(total)}/${ctx.commonDen}</strong>!</p>`;
                    html += `</div>`;
                } else {
                    const wholeTotal = total / ctx.commonDen;
                    if (Number.isInteger(wholeTotal)) {
                         html += `<div class="alert alert-success border-success" role="alert">`;
                         html += `<h5 class="alert-heading fw-bold">üéâ Resultado Inteiro!</h5>`;
                         html += `<p class="mb-0">A subtra√ß√£o deu <strong>${total}/${ctx.commonDen}</strong>, que √© igual a <strong>${wholeTotal}</strong> inteiros!</p>`;
                         html += `</div>`;
                    } else {
                        html += `<p class="fw-bold text-success">Resultado final: ${total}/${ctx.commonDen}</p>`;
                    }
                }
            }
        }

        document.getElementById('explainContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('explainModal')).show();
    }

    function drawMoney(ctx, amount) {
        // Limpa a √°rea
        ctx.clearRect(0,0,300,300);
        
        // Define o texto de d√≠vida
        ctx.font = "bold 24px 'Segoe UI', sans-serif";
        ctx.fillStyle = "#C62828";
        ctx.textAlign = "center";
        ctx.fillText("Ficou devendo!", 150, 40);
        
        // Desenha uma nota de dinheiro estilizada
        const cx = 150, cy = 150;
        const w = 220, h = 100;
        const x = cx - w/2;
        const y = cy - h/2;
        
        // Sombra
        ctx.fillStyle = "rgba(0,0,0,0.1)";
        roundRect(ctx, x+5, y+5, w, h, 10, true, false);
        
        // Nota base
        ctx.fillStyle = "#E0E0E0"; // Cor de papel moeda gen√©rico/cinza
        ctx.strokeStyle = "#9E9E9E";
        ctx.lineWidth = 2;
        roundRect(ctx, x, y, w, h, 10, true, true);
        
        // Detalhes da nota
        ctx.strokeStyle = "#BDBDBD";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x+20, y+10); ctx.lineTo(x+w-20, y+10);
        ctx.moveTo(x+20, y+h-10); ctx.lineTo(x+w-20, y+h-10);
        ctx.stroke();
        
        // C√≠rculo central com valor
        ctx.beginPath();
        ctx.arc(cx, cy, 35, 0, Math.PI*2);
        ctx.fillStyle = "white";
        ctx.fill();
        ctx.strokeStyle = "#9E9E9E";
        ctx.stroke();
        
        // Valor da d√≠vida
        ctx.fillStyle = "#C62828";
        ctx.font = "bold 28px monospace";
        ctx.fillText("R$ " + Math.abs(amount).toFixed(2), cx, cy + 10);
        
        // Faixa vermelha de "D√çVIDA"
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(-0.2);
        ctx.fillStyle = "rgba(198, 40, 40, 0.8)";
        ctx.fillRect(-80, -15, 160, 30);
        ctx.fillStyle = "white";
        ctx.font = "bold 16px sans-serif";
        ctx.fillText("D√çVIDA", 0, 6);
        ctx.restore();
    }

    function animate(n1, n2, den, mode, food) {
        let p = 0;
        const ctx1 = document.getElementById('c1').getContext('2d');
        const ctx2 = document.getElementById('c2').getContext('2d');
        const ctx3 = document.getElementById('c3').getContext('2d');

        function loop() {
            p += 0.01;
            let ease = p < 1 ? 1 - Math.pow(1 - p, 3) : 1; 
            
            ctx1.clearRect(0,0,300,300);
            if (mode !== 'view') {
                ctx2.clearRect(0,0,300,300);
                // N√£o limpamos ctx3 aqui se for d√≠vida, pois drawMoney j√° limpa. 
                // Mas para garantir anima√ß√£o correta, limpamos se n√£o for d√≠vida ou sempre limpamos e redesenhamos.
                // Melhor limpar sempre para garantir.
                ctx3.clearRect(0,0,300,300);
            }

            drawAsset(ctx1, n1 * ease, den, food, "#FF7043", n1);
            
            if (mode !== 'view') {
                drawAsset(ctx2, n2 * ease, den, food, "#FFA726", n2);
                
                const rawRes = mode === 'add' ? (n1 + n2) : (n1 - n2);
                const isNegative = rawRes < 0;
                
                if (isNegative && p > 0.1) {
                    // Visualiza√ß√£o de d√≠vida
                    // Usamos rawRes para mostrar o valor. 
                    // Como √© fra√ß√£o, o "valor" monet√°rio seria proporcional.
                    // Vamos simplificar e mostrar o valor da fra√ß√£o negativa como "valor devido"
                    // Mas o pedido menciona "notas de dinheiro". Vamos desenhar a nota.
                    // Para animar, podemos fazer a nota aparecer com fade ou scale.
                    // Aqui faremos simples: se negativo, desenha a nota.
                    
                    // O valor monet√°rio fict√≠cio ser√° a fra√ß√£o resultante.
                    // Ex: -1/3 -> R$ 0.33 (apenas ilustrativo)
                    const val = rawRes / den;
                    drawMoney(ctx3, val);
                } else {
                     const res = mode === 'add' ? (n1 + n2 * ease) : (n1 - n2 * ease);
                     const cap = mode === 'add' ? (n1 + n2) : n1;
                     // Se for negativo mas ainda estamos animando a subtra√ß√£o "antes" de virar d√≠vida visualmente?
                     // Na verdade, subtra√ß√£o visual de pizzas √© dif√≠cil quando vai abaixo de zero.
                     // Vamos manter o comportamento padr√£o (Math.max(0...)) at√© que termine ou se for positivo.
                     // Mas se o resultado final √© negativo, substituimos por dinheiro.
                     
                     if (!isNegative) {
                        drawAsset(ctx3, Math.max(0, res), den, food, "#66BB6A", cap);
                     }
                }
            }

            if (p < 1) animId = requestAnimationFrame(loop);
        }
        loop();
    }

    function drawAsset(ctx, n, d, type, color, capacity) {
        const cap = (capacity !== undefined) ? capacity : n;
        const numShapes = Math.max(1, Math.ceil(cap / d));
        
        let cols = 1, rows = 1;
        if (numShapes === 2) {
            cols = 2; rows = 1;
        } else if (numShapes > 2) {
            cols = Math.ceil(Math.sqrt(numShapes));
            rows = Math.ceil(numShapes / cols);
        }
        
        const scale = 1 / Math.max(cols, rows);
        const cellW = 300 / cols;
        const cellH = 300 / rows;
        
        for(let k=0; k<numShapes; k++) {
            const localN = Math.max(0, Math.min(d, n - k * d));
            const c = k % cols;
            const r = Math.floor(k / cols);
            const posX = c * cellW + cellW / 2;
            const posY = r * cellH + cellH / 2;
            
            ctx.save();
            ctx.translate(posX, posY);
            ctx.scale(scale, scale);
            ctx.translate(-150, -150);
            drawUnit(ctx, localN, d, type, color);
            ctx.restore();
        }
    }

    function drawUnit(ctx, n, d, type, color) {
        const cx = 150, cy = 150, r = 130;
        
        if (type === 'pizza') {
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
            ctx.fillStyle = "#E6A65C"; ctx.fill();
            ctx.beginPath(); ctx.arc(cx, cy, r - 10, 0, Math.PI*2);
            ctx.fillStyle = "#FFF59D"; ctx.fill();
            for(let i=0; i<d; i++) {
                const start = (i * 2 * Math.PI) / d - (Math.PI/2);
                const end = ((i+1) * 2 * Math.PI) / d - (Math.PI/2);
                ctx.beginPath(); ctx.moveTo(cx, cy); 
                ctx.arc(cx, cy, r-10, start, end); ctx.lineTo(cx, cy);
                ctx.strokeStyle = "#FBC02D"; ctx.stroke();
                
                // Se n for 0, fillAmount ser√° 0 ou menor, e nada ser√° desenhado aqui
                const fillAmount = Math.max(0, Math.min(1, n - i));
                
                if (fillAmount > 0) {
                    ctx.beginPath(); ctx.moveTo(cx, cy);
                    const currEnd = start + (end - start) * fillAmount;
                    ctx.arc(cx, cy, r-10, start, currEnd); ctx.lineTo(cx, cy);
                    ctx.fillStyle = color; ctx.fill();
                    if (fillAmount > 0.8) {
                        ctx.save(); ctx.clip(); ctx.fillStyle = "#B71C1C";
                        drawPepperoni(ctx, cx, cy, r, start, end, (i + 1) * 123);
                        ctx.restore();
                    }
                }
            }
        } else {
            const w = 240, h = 180, x0 = cx - w/2, y0 = cy - h/2;
            ctx.fillStyle = "#5D4037"; roundRect(ctx, x0-5, y0-5, w+10, h+10, 10, true, false);
            const cols = d <= 4 ? d : Math.ceil(Math.sqrt(d)), rows = Math.ceil(d / cols);
            const pieceW = w / cols, pieceH = h / rows;
            for(let i=0; i<d; i++) {
                const c = i % cols, r_idx = Math.floor(i / cols);
                const px = x0 + c * pieceW, py = y0 + r_idx * pieceH;
                const fillAmount = Math.max(0, Math.min(1, n - i));
                
                ctx.fillStyle = "#8D6E63"; ctx.fillRect(px + 2, py + 2, pieceW - 4, pieceH - 4);
                if (fillAmount > 0) {
                    ctx.fillStyle = color; ctx.fillRect(px + 2, py + 2, (pieceW - 4) * fillAmount, pieceH - 4);
                    ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.fillRect(px + 2, py + 2, ((pieceW - 4)*fillAmount), (pieceH - 4)/2);
                }
            }
        }
    }
    function drawPepperoni(ctx, cx, cy, r, start, end, seed) {
        const angleMid = (start + end) / 2; const dists = [0.4, 0.6, 0.7]; const offsets = [-0.1, 0.1, -0.05];
        for(let k=0; k<3; k++) {
            const dist = r * dists[k], ang = angleMid + offsets[k];
            ctx.beginPath(); ctx.arc(cx + Math.cos(ang) * dist, cy + Math.sin(ang) * dist, 6, 0, Math.PI*2); ctx.fill();
        }
    }
    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
        ctx.beginPath(); ctx.moveTo(x+r, y); ctx.lineTo(x+w-r, y); ctx.quadraticCurveTo(x+w, y, x+w, y+r);
        ctx.lineTo(x+w, y+h-r); ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
        ctx.lineTo(x+r, y+h); ctx.quadraticCurveTo(x, y+h, x, y+h-r); ctx.lineTo(x, y+r); ctx.quadraticCurveTo(x, y, x+r, y);
        ctx.closePath(); if (fill) ctx.fill(); if (stroke) ctx.stroke();
    }

    updateUI(); // Inicia
</script>
</body>
</html>